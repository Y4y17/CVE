# Arbitrary file deletion vulnerability
##### Vulnerability Location: /sys/apps/controllers/admin/Backups.php
##### Affected Range: McCms v2.7.0
##### Vulnerability Cause: Backups.php contains a serious security vulnerability that allow attackers to delete any file.
##### Vulnerability Impact: The application or operating system is not running properly
##### Link: https://www.mccms.cn/
# Vulnerability recurrence

After logging in, at the system backup function point, first back up a file, as shown in Mccms-20250522 below. You can see that there is an operation to delete the backup file below:

<img width="1427" alt="image" src="https://github.com/user-attachments/assets/42257348-7133-49bc-ab6b-1eed76654512" />

Attempt to delete Mccms-20250522 and capture the corresponding data packets:

<img width="1432" alt="image" src="https://github.com/user-attachments/assets/37ed9a8f-b146-4349-a6f7-4099f5c4e750" />

The url address in the data packet is backups/restore_del, and thus it is located in the source code:

<img width="669" alt="image" src="https://github.com/user-attachments/assets/608ca445-f183-4755-a277-8cd94aa85426" />

The encryption key is hard-coded in the source code, allowing users to generate new parameter values based on the encryption key and the corresponding encryption code. Here, a "test" folder is created in the same directory as the source code to regenerate the parameter values:

<img width="1370" alt="image" src="https://github.com/user-attachments/assets/9593e0ea-3878-46b0-bec9-f7fcf0db974d" />

The data packet was replayed and a prompt indicating successful deletion was found：

<img width="1444" alt="image" src="https://github.com/user-attachments/assets/19994324-ea7d-4756-9328-2244b9e8beaf" />

Then I searched to see if the "test" directory existed and found that it had been deleted：

<img width="830" alt="image" src="https://github.com/user-attachments/assets/a25ac176-a876-4c18-a36f-fa9c6e8bbea3" />

It can be found that the "test" folder does not exist under the directory "D:\phpstudy_pro\WWW"

# Code Analysis

<img width="625" alt="image" src="https://github.com/user-attachments/assets/d51ed118-fdeb-4c0c-b30c-6cd41dedc08d" />

The passed dir is an array. Traverse this array, then decrypt it, and call the sys_auth method! Determine whether the decrypted dir has a value, and then call the delete_files function to delete the files under the directory! Follow up in the sys_auth method:

<img width="1084" alt="image" src="https://github.com/user-attachments/assets/b64f1427-811b-4ff9-aac7-4798e39d0ef3" />

When the sys_auth method is called, the key variable is not passed. Therefore, the key variable here is the constant value of Mc_Encryption_Key! View this value:

<img width="776" alt="image" src="https://github.com/user-attachments/assets/59aed29c-f8db-4118-97b8-315013b1bb5a" />

The encrypted key is hard-coded in the source code, so malicious parameter values can be generated based on this value!

Next, follow up to the delete_files method to see how to delete the files:

<img width="1512" alt="image" src="https://github.com/user-attachments/assets/48a69f00-9518-44ef-bef2-d9c642f94639" />

It can be seen that the first step is to determine whether the variable dir can be opened, that is, to check if it is a directory. If not, it directly returns FALSE! Deleting the file was unsuccessful! But the folder can be deleted! This has led to the deletion of any file!
